---
title: Carthage 简介
date: 2016-08-19 10:38:00
categories: Carthage
---

Carthage 是一个年轻的 iOS 包管理工具，为什么在有了 CocoaPods 之后，还会出现 Carthage, Carthage 官方的理由如下：
	
* CocoaPods 默认自动创建 workspace 来管理 application 和所有依赖， Carthage 使用 xcodebuild 编译二进制 framework, 把集成的权力交给使用者， CocoaPods 的目标是容易使用， Carthage 的目标是灵活性和非侵入性。
* CocoaPods 的说明文档中提到，为了提高第三方开源框架的集成能力以及容易扩散，创建的集中的生态系统。Carthage 的目标只是一个分散的依赖管理工具，没有维护一个所有项目的列表。（这样能避免很多集中依赖节点出错导致的问题，可能会造成开源库不容易被发现，建议使用 GitHub 的 Trending）

<!--more-->

## Carthage VS CocoaPods

CocoaPods 的优点：

* 使用方便，除了写 Podfile 之外基本都是命令行完成
* 支持静态库，也支持 iOS 8 以上的 framework
* 软件包比较多，主流支持

缺点：

* 每个默认更新都要更新 podsepc 仓库，很耗时
* 创建支持 CocoaPods 的相对繁琐， podsepc 写起来比较麻烦
* 每次 clean 之后编译，都要重新编译所有第三方库

Carthage 的优点：

* 将 framework 集成到项目中，不需要重复编译
* 无缝兼容 CocoaPods
* 没有中心仓库，更新很快
* 结构标准的项目天然支持 Carthage

缺点：
 
* 支持的库相对少一些
* 只支持 framework ，iOS 8 以上
* 无法定位源码，直接断点调试


## Carthage 使用介绍 

安装 carthage 到系统，请下载并运行最新的 [Release](https://github.com/Carthage/Carthage/releases) Carthage.pkg 文件。另一种选择是使用 Homebrew 并安装 carthage 工具到系统并运行 `brew update` 和 `brew install carthage`。
如果想运行最新的开发版本（很有可能不稳定或不兼容），只需要简单的 clone 仓库的 master 分支，并运行 make install。

### 使用 Carthage 发布 Framework

Carthage 官方只支持**dynamic frameworks.** Dynamic frameworks 在OSX上支持任何版本，iOS上只支持 iOS8 及以上版本。

由于 Carthage 没有中心化的 package list，也没有项目说明格式，大部分 frameworks 应该自动构建。通过将编译 scheme 共享，让 Carthage 通过 xcodebuild 编译。通过运行 `carthage build --no-skip-current` 后检查 Build 文件夹来检测是否构建成功。

### 使用 Carthage 集成 Framework

#### OSX 项目

1. 创建一个 Cartfile ，在这个文件中列出你想使用的 frameworks
2. 运行 carthage update ，获取依赖到 Carthage/Checkouts 文件夹，逐个构建
3. 在工程的 target－> General 选项下，拖拽 Carthage/Build 文件夹内想要添加的 framework 到 “Embedded Binaries” 选项下。

#### iOS, tvOS, watchOS 项目

1. 创建一个 Cartfile ，在这个文件中列出你想使用的 frameworks
2. 运行 carthage update ，获取依赖到 Carthage/Checkouts 文件夹，逐个构建
3. 在工程的 target－> General 选项下，拖拽 Carthage/Build 文件夹内想要添加的 framework 到 “Linked Frameworks and Libraries” 选项下。
4. 在工程的 target－> Build Phases 选项下，点击 “+” 按钮，选择 “New Run Script Phase” ，填入如下内容：
	
	```
	/usr/local/bin/carthage copy-frameworks
	```
	并在 “Input Files” 选项里添加 framework 路径

	```
	$(SRCROOT)/Carthage/Build/iOS/LlamaKit.framework
	$(SRCROOT)/Carthage/Build/iOS/ReactiveCocoa.framework
	```
	
#### 拷贝 debug symbols 来调试和报告 crash

在工程的 target－> Build Phases 选项下，点击 “+” 按钮，选择 “New Copy Files Phase”.
点击 “Destination” 下拉菜单，选择 “Products Directory”.
针对每个使用的 framework，拖拽它们的 dSYM 文件。
当调试信息被拷贝到 built products 目录，Xcode 在断点处将符号化调用堆栈。也可以使其深入到第三方代码中去。

当提交到 AppStore 或者 TestFlight，Xcode 也会拷贝这些文件到应用的 .xcarchive bundle 的 dSYMs 子目录。

#### 同步

在这个过程中，Carthage 会创建一些 Artifacts，最重要的是 Cartfile.resolved 文件，该文件列出了每个 framework 构建的各个版本。确保提交你的Cartfile.resolved, 因为任何人都需要那个文件来构建相同的 framework 版本。

在你完成了上述步骤并 push 了你的改变，其他用户只需要 fetch 这个仓库，运行 carthage boostrap来开始你添加的 framework。

#### 升级 frameworks

如果修改 Cartfile，或者将每个 framework 升级到最新的版本，只需要再次运行 carthage update。

#### 使用 submodules 做依赖

默认情况下，Carthage 将直接 checkout 依赖源文件到项目文件夹中，提交或者忽略全自己掌控。如果希望依赖用 Git submodules 代替（或许这样你就可以在他们内部commit，push），可以通过运行 carthage update 或者 carthage checkout --use-submodules

运行之后，Carthage 会在仓库中写入 .gitmodules 和 .git/config 文件，并自动更新当依赖的版本发生变化的时候。

#### 自动重新构建依赖

在开发过程中，如果想修改依赖项目中的代码，并在编译父项目的时候自动重新编译，可以添加一个 Run Script 来唤醒 Carthage，像这样：

```
/usr/local/bin/carthage build --platform "$PLATFORM_NAME" "$SRCROOT"
```

注意：在这样做之前首先需要 使用 submodules，因为 plain checkouts 不能被直接修改

